version: "3.8"

services:
  mcp-server:
    build: .
    image: qa-mcp-server:latest
    container_name: qa-mcp-server
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "8000:8000"
    volumes:
      # Mount data dir for symbol_index.db persistence
      - ./data:/data
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import socket; socket.create_connection(('localhost', 8000), timeout=5)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - mcp-network

  # Optional: debug REST layer (FastAPI HTTP server).
  # Run with: docker-compose --profile debug up
  debug-http:
    build: .
    image: qa-mcp-server:latest
    container_name: qa-mcp-debug
    restart: "no"
    env_file:
      - .env
    environment:
      - DATABASE_URL=${BASE_URL}mag
    ports:
      - "8001:8001"
    volumes:
      - ./data:/data
    command:
      [
        "python",
        "-m",
        "uvicorn",
        "app.server:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8001",
      ]
    networks:
      - mcp-network
    profiles:
      - debug

networks:
  mcp-network:
    driver: bridge
